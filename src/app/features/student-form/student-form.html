<div class="max-w-4xl mx-auto space-y-6">
  <!-- Back Button -->
  <a 
    routerLink="/students" 
    class="inline-flex items-center px-4 py-2 rounded-lg bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-900 dark:text-white border border-gray-300 dark:border-gray-600 transition-all duration-200 group"
  >
    <i class="fa-solid fa-arrow-left mr-2 group-hover:-translate-x-1 transition-transform duration-200"></i>
    Back to Student List
  </a>

  <!-- Form Card -->
  <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 p-6 md:p-8 rounded-lg shadow-sm">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
          {{ isEditMode ? 'Edit Student' : 'Add New Student' }}
        </h1>
        @if (!isEditMode) {
          <p class="text-gray-600 dark:text-gray-300 mt-1">Create a new student record</p>
        }
      </div>
      <div class="flex items-center space-x-2 text-sm text-gray-500 dark:text-gray-400">
        <i class="fa-solid fa-circle-info"></i>
        <span>* Required fields</span>
      </div>
    </div>

    <form [formGroup]="studentForm" (ngSubmit)="onSubmit()" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Student ID -->
        <div class="space-y-2">
          <label for="studentId" class="block text-sm font-medium text-gray-900 dark:text-white">
            Student ID <span class="text-red-500">*</span>
          </label>
          <input 
            type="text" 
            id="studentId" 
            formControlName="studentId" 
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
            [class.border-red-500]="isControlInvalid('studentId')"
            [readOnly]="isEditMode"
            placeholder="Enter student ID"
          >
          @if (isControlInvalid('studentId')) {
            <div class="text-red-600 dark:text-red-400 text-sm mt-1">
              @if (getControl('studentId').hasError('required')) { 
                <div class="flex items-center">
                  <i class="fa-solid fa-exclamation-circle mr-1 text-xs"></i>
                  Student ID is required
                </div>
              }
              @if (getControl('studentId').hasError('maxlength')) { 
                <div class="flex items-center">
                  <i class="fa-solid fa-exclamation-circle mr-1 text-xs"></i>
                  Maximum 100 characters allowed
                </div>
              }
            </div>
          }
        </div>

        <!-- Department -->
        <div class="space-y-2">
          <label for="departmentId" class="block text-sm font-medium text-gray-900 dark:text-white">
            Department <span class="text-red-500">*</span>
          </label>
          <select 
            id="departmentId" 
            formControlName="departmentId" 
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
            [class.border-red-500]="isControlInvalid('departmentId')"
          >
            <option [ngValue]="null" disabled selected>Select a department</option>
            @for (dept of departmentOptions(); track dept.value) {
              <option [ngValue]="dept.value">{{ dept.label | titlecase | replaceUnderscore }}</option>
            }
          </select>
          @if (isControlInvalid('departmentId')) {
            <div class="text-red-600 dark:text-red-400 text-sm mt-1">
              <div class="flex items-center">
                <i class="fa-solid fa-exclamation-circle mr-1 text-xs"></i>
                Please select a department
              </div>
            </div>
          }
        </div>

        <!-- First Name -->
        <div class="space-y-2">
          <label for="firstName" class="block text-sm font-medium text-gray-900 dark:text-white">
            First Name <span class="text-red-500">*</span>
          </label>
          <input 
            type="text" 
            id="firstName" 
            formControlName="firstName" 
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
            [class.border-red-500]="isControlInvalid('firstName')"
            placeholder="Enter first name"
          >
          @if (isControlInvalid('firstName')) {
            <div class="text-red-600 dark:text-red-400 text-sm mt-1">
              @if (getControl('firstName').hasError('required')) { 
                <div class="flex items-center">
                  <i class="fa-solid fa-exclamation-circle mr-1 text-xs"></i>
                  First name is required
                </div>
              }
              @if (getControl('firstName').hasError('minlength')) { 
                <div class="flex items-center">
                  <i class="fa-solid fa-exclamation-circle mr-1 text-xs"></i>
                  Must be at least 2 characters long
                </div>
              }
              @if (getControl('firstName').hasError('pattern')) { 
                <div class="flex items-center">
                  <i class="fa-solid fa-exclamation-circle mr-1 text-xs"></i>
                  Only letters and spaces allowed
                </div>
              }
            </div>
          }
        </div>

        <!-- Last Name -->
        <div class="space-y-2">
          <label for="lastName" class="block text-sm font-medium text-gray-900 dark:text-white">
            Last Name <span class="text-red-500">*</span>
          </label>
          <input 
            type="text" 
            id="lastName" 
            formControlName="lastName" 
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
            [class.border-red-500]="isControlInvalid('lastName')"
            placeholder="Enter last name"
          >
          @if (isControlInvalid('lastName')) {
            <div class="text-red-600 dark:text-red-400 text-sm mt-1">
              @if (getControl('lastName').hasError('required')) { 
                <div class="flex items-center">
                  <i class="fa-solid fa-exclamation-circle mr-1 text-xs"></i>
                  Last name is required
                </div>
              }
              @if (getControl('lastName').hasError('minlength')) { 
                <div class="flex items-center">
                  <i class="fa-solid fa-exclamation-circle mr-1 text-xs"></i>
                  Must be at least 2 characters long
                </div>
              }
              @if (getControl('lastName').hasError('pattern')) { 
                <div class="flex items-center">
                  <i class="fa-solid fa-exclamation-circle mr-1 text-xs"></i>
                  Only letters and spaces allowed
                </div>
              }
            </div>
          }
        </div>

        <!-- Email -->
        <div class="md:col-span-2 space-y-2">
          <label for="email" class="block text-sm font-medium text-gray-900 dark:text-white">
            Email Address <span class="text-red-500">*</span>
          </label>
          <input 
            type="email" 
            id="email" 
            formControlName="email" 
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
            [class.border-red-500]="isControlInvalid('email')"
            placeholder="Enter email address"
          >
          @if (isControlInvalid('email')) {
            <div class="text-red-600 dark:text-red-400 text-sm mt-1">
              @if (getControl('email').hasError('required')) { 
                <div class="flex items-center">
                  <i class="fa-solid fa-exclamation-circle mr-1 text-xs"></i>
                  Email address is required
                </div>
              }
              @if (getControl('email').hasError('email')) { 
                <div class="flex items-center">
                  <i class="fa-solid fa-exclamation-circle mr-1 text-xs"></i>
                  Please enter a valid email address
                </div>
              }
            </div>
          }
        </div>

        <!-- Courses (Multi-select with ng-select) -->
        <div class="md:col-span-2 space-y-2">
          <label for="courseIds" class="block text-sm font-medium text-gray-900 dark:text-white">
            Courses <span class="text-red-500">*</span>
          </label>
          <ng-select
            id="courseIds"
            formControlName="courseIds"
            [items]="courses()"
            bindLabel="name"
            bindValue="id"
            [multiple]="true"
            [closeOnSelect]="false"
            [searchable]="true"
            [clearable]="true"
            [hideSelected]="false"
            placeholder="Select courses..."
            [notFoundText]="isDepartmentSelected() ? 'No courses available for this department' : 'Please select a department first'"
            [class.border-red-500]="isControlInvalid('courseIds')"
            [disabled]="!isDepartmentSelected()"
            class="ng-select-custom"
          >
            <ng-template ng-label-tmp let-item="item" let-clear="clear">
              <span class="inline-flex items-center bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-md text-sm font-medium mr-1 mb-1">
                <i class="fa-solid fa-book mr-1 text-xs opacity-70"></i>
                {{ item.name }}
                <button 
                  type="button"
                  class="ml-1 text-blue-600 dark:text-blue-300 hover:text-blue-800 dark:hover:text-blue-100 focus:outline-none"
                  (click)="clear(item)" 
                  (mousedown)="$event.preventDefault()"
                  aria-label="Remove course"
                >
                  <i class="fa-solid fa-xmark text-xs"></i>
                </button>
              </span>
            </ng-template>
            <ng-template ng-option-tmp let-item="item" let-index="index">
              <div class="flex items-center py-2 px-3 hover:bg-gray-100 dark:hover:bg-gray-600">
                <i class="fa-solid fa-book mr-3 text-gray-400 dark:text-gray-500"></i>
                <span class="text-gray-700 dark:text-gray-300">{{ item.name }}</span>
              </div>
            </ng-template>
          </ng-select>
          @if (isControlInvalid('courseIds')) {
            <div class="text-red-600 dark:text-red-400 text-sm mt-1">
              <div class="flex items-center">
                <i class="fa-solid fa-exclamation-circle mr-1 text-xs"></i>
                At least one course must be selected
              </div>
            </div>
          }
          @if (isDepartmentSelected() && courses().length > 0) {
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
              {{ getControl('courseIds').value?.length || 0 }} of {{ courses().length }} courses selected
            </p>
          }
        </div>
      </div>

      <!-- Submission Button -->
      <div class="flex flex-col sm:flex-row justify-between items-center gap-4 pt-6 border-t border-gray-200 dark:border-gray-600">
        <div class="text-sm text-gray-500 dark:text-gray-400">
          @if (studentForm.dirty) {
            <i class="fa-solid fa-circle-exclamation mr-1 text-green-500"></i>
            <span>You have unsaved changes</span>
          }
        </div>
        <button 
          type="submit" 
          [disabled]="studentForm.invalid || state().status === 'submitting'" 
          class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 disabled:bg-blue-300 text-white py-2.5 px-6 rounded-md font-medium flex items-center justify-center transition-colors duration-200 min-w-[140px]"
        >
          @if (state().status === 'submitting') {
            <i class="fa-solid fa-spinner fa-spin mr-2"></i>
            <span>Saving...</span>
          } @else {
            <i class="fa-solid mr-2" [class.fa-user-plus]="!isEditMode" [class.fa-floppy-disk]="isEditMode"></i>
            <span>{{ isEditMode ? 'Save Changes' : 'Add Student' }}</span>
          }
        </button>
      </div>
    </form>
  </div>
  
  <!-- Feedback Messages -->
  @if (state().status === 'error' && state().message) {
    <div class="p-4 bg-red-100 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-300 rounded-lg animate-fade-in">
      <div class="flex items-start space-x-3">
        <i class="fa-solid fa-circle-exclamation mt-0.5 text-red-500"></i>
        <div class="flex-1">
          <strong class="font-semibold">Unable to save student:</strong>
          @if(isArray(state().message)){
            <ul class="list-disc list-inside mt-2 space-y-1">
              @for(error of state().message; track error){
                <li>{{ error }}</li>
              }
            </ul>
          } @else {
            <p class="mt-1">{{ state().message }}</p>
          }
        </div>
      </div>
    </div>
  }

  @if (state().status === 'success') {
    <div class="p-4 bg-green-100 dark:bg-green-900/20 border border-green-200 dark:border-green-800 text-green-700 dark:text-green-300 rounded-lg animate-fade-in">
      <div class="flex items-center space-x-3">
        <i class="fa-solid fa-circle-check text-green-500"></i>
        <div>
          <strong class="font-semibold">Success!</strong>
          <p class="mt-1">{{ state().message }}</p>
        </div>
      </div>
    </div>
  }
</div>